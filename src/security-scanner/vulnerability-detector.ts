/**
 * Vulnerability Detector - Detects specific security vulnerabilities
 */

import {
  Vulnerability,
  VulnerabilityType,
  VulnerabilitySeverity,
  SecurityRule,
  OWASPCategory,
} from './types';

export class VulnerabilityDetector {
  private rules: SecurityRule[];

  constructor() {
    this.rules = this.initializeRules();
  }

  /**
   * Detect vulnerabilities in code
   */
  detectVulnerabilities(
    code: string,
    filePath: string
  ): Vulnerability[] {
    const vulnerabilities: Vulnerability[] = [];

    for (const rule of this.rules) {
      const findings = this.applyRule(rule, code, filePath);
      vulnerabilities.push(...findings);
    }

    return vulnerabilities;
  }

  /**
   * Apply a security rule to code
   */
  private applyRule(
    rule: SecurityRule,
    code: string,
    filePath: string
  ): Vulnerability[] {
    const vulnerabilities: Vulnerability[] = [];
    const lines = code.split('\n');

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      const pattern =
        typeof rule.pattern === 'string'
          ? new RegExp(rule.pattern, 'g')
          : rule.pattern;

      const matches = line.matchAll(pattern);

      for (const match of matches) {
        vulnerabilities.push({
          id: `${rule.id}-${i + 1}`,
          type: rule.type,
          severity: rule.severity,
          title: rule.name,
          description: rule.description,
          file: filePath,
          location: {
            startLine: i + 1,
            endLine: i + 1,
            startColumn: match.index,
            endColumn: match.index! + match[0].length,
          },
          code: {
            source: match[0],
            highlight: match[0],
            context: this.getContext(lines, i),
          },
          owaspCategory: rule.owaspCategory,
          remediation: {
            description: rule.remediation,
            steps: this.getRemediationSteps(rule.type),
            effort: this.estimateEffort(rule.type),
            references: this.getReferences(rule.type),
          },
          references: this.getReferences(rule.type),
        });
      }
    }

    return vulnerabilities;
  }

  /**
   * Initialize security rules
   */
  private initializeRules(): SecurityRule[] {
    return [
      // SQL Injection
      {
        id: 'sql-injection-1',
        name: 'SQL Injection via String Concatenation',
        type: 'sql-injection',
        severity: 'critical',
        pattern: /query\s*\+\s*['"`]|['"`]\s*\+\s*\w+\s*\+\s*['"`].*(?:SELECT|INSERT|UPDATE|DELETE)/i,
        description:
          'SQL query constructed using string concatenation with user input',
        remediation: 'Use parameterized queries or prepared statements',
        owaspCategory: 'A03-injection',
      },
      {
        id: 'sql-injection-2',
        name: 'SQL Injection via Template Literals',
        type: 'sql-injection',
        severity: 'critical',
        pattern: /`(?:SELECT|INSERT|UPDATE|DELETE).*\$\{/i,
        description: 'SQL query constructed using template literals with variables',
        remediation: 'Use parameterized queries instead of template literals',
        owaspCategory: 'A03-injection',
      },

      // XSS (Cross-Site Scripting)
      {
        id: 'xss-1',
        name: 'XSS via innerHTML',
        type: 'xss',
        severity: 'high',
        pattern: /\.innerHTML\s*=\s*(?!\s*['"`])/,
        description: 'Setting innerHTML with unsanitized user input',
        remediation: 'Use textContent or sanitize input with DOMPurify',
        owaspCategory: 'A03-injection',
      },
      {
        id: 'xss-2',
        name: 'XSS via dangerouslySetInnerHTML',
        type: 'xss',
        severity: 'high',
        pattern: /dangerouslySetInnerHTML/,
        description:
          'React component using dangerouslySetInnerHTML with potentially unsafe content',
        remediation: 'Sanitize HTML content before rendering',
        owaspCategory: 'A03-injection',
      },
      {
        id: 'xss-3',
        name: 'XSS via eval',
        type: 'xss',
        severity: 'critical',
        pattern: /\beval\s*\(/,
        description: 'Using eval() with user input can lead to code injection',
        remediation: 'Never use eval() with user input. Use safer alternatives',
        owaspCategory: 'A03-injection',
      },

      // Command Injection
      {
        id: 'command-injection-1',
        name: 'Command Injection via exec',
        type: 'command-injection',
        severity: 'critical',
        pattern: /exec\s*\(\s*['"`].*\$\{|exec\s*\(\s*\w+\s*\+/,
        description: 'Executing shell commands with unsanitized user input',
        remediation: 'Use execFile() with argument array or validate/escape input',
        owaspCategory: 'A03-injection',
      },
      {
        id: 'command-injection-2',
        name: 'Command Injection via spawn',
        type: 'command-injection',
        severity: 'high',
        pattern: /spawn\s*\(\s*['"`].*\$\{|spawn\s*\(\s*\w+\s*\+/,
        description: 'Spawning process with unsanitized user input',
        remediation: 'Use spawn() with argument array instead of shell string',
        owaspCategory: 'A03-injection',
      },

      // Path Traversal
      {
        id: 'path-traversal-1',
        name: 'Path Traversal',
        type: 'path-traversal',
        severity: 'high',
        pattern: /(?:readFile|writeFile|createReadStream|createWriteStream)\s*\(\s*\w+\s*\+|`[^`]*\$\{[^}]*\}[^`]*`\s*\)/,
        description: 'File operation with unsanitized user input in path',
        remediation: 'Validate and sanitize file paths, use path.join() and check boundaries',
        owaspCategory: 'A01-broken-access-control',
      },

      // Hardcoded Secrets
      {
        id: 'hardcoded-secret-1',
        name: 'Hardcoded Password',
        type: 'hardcoded-secrets',
        severity: 'critical',
        pattern: /password\s*=\s*['"`][^'"`]{8,}['"`]/i,
        description: 'Hardcoded password found in source code',
        remediation: 'Store secrets in environment variables or secret manager',
        owaspCategory: 'A02-cryptographic-failures',
      },
      {
        id: 'hardcoded-secret-2',
        name: 'Hardcoded API Key',
        type: 'hardcoded-secrets',
        severity: 'critical',
        pattern: /(?:api[_-]?key|apikey|api[_-]?secret)\s*=\s*['"`][A-Za-z0-9]{20,}['"`]/i,
        description: 'Hardcoded API key found in source code',
        remediation: 'Store API keys in environment variables',
        owaspCategory: 'A02-cryptographic-failures',
      },
      {
        id: 'hardcoded-secret-3',
        name: 'Hardcoded AWS Credentials',
        type: 'hardcoded-secrets',
        severity: 'critical',
        pattern: /AKIA[0-9A-Z]{16}/,
        description: 'Hardcoded AWS access key found',
        remediation: 'Use AWS IAM roles or environment variables',
        owaspCategory: 'A02-cryptographic-failures',
      },

      // Weak Cryptography
      {
        id: 'weak-crypto-1',
        name: 'Weak Hash Algorithm (MD5)',
        type: 'weak-crypto',
        severity: 'high',
        pattern: /createHash\s*\(\s*['"`]md5['"`]/i,
        description: 'Using MD5 hash algorithm which is cryptographically broken',
        remediation: 'Use SHA-256 or stronger algorithms',
        owaspCategory: 'A02-cryptographic-failures',
      },
      {
        id: 'weak-crypto-2',
        name: 'Weak Hash Algorithm (SHA1)',
        type: 'weak-crypto',
        severity: 'medium',
        pattern: /createHash\s*\(\s*['"`]sha1['"`]/i,
        description: 'Using SHA1 hash algorithm which is deprecated',
        remediation: 'Use SHA-256 or stronger algorithms',
        owaspCategory: 'A02-cryptographic-failures',
      },
      {
        id: 'weak-crypto-3',
        name: 'Insecure Random Number Generation',
        type: 'weak-crypto',
        severity: 'medium',
        pattern: /Math\.random\(\)/,
        description: 'Using Math.random() for security-sensitive operations',
        remediation: 'Use crypto.randomBytes() for cryptographic operations',
        owaspCategory: 'A02-cryptographic-failures',
      },

      // Insecure Deserialization
      {
        id: 'insecure-deser-1',
        name: 'Unsafe JSON Parsing',
        type: 'insecure-deserialization',
        severity: 'medium',
        pattern: /JSON\.parse\s*\(\s*(?!['"`])/,
        description: 'Parsing JSON from untrusted source without validation',
        remediation: 'Validate JSON schema before parsing',
        owaspCategory: 'A08-software-data-integrity',
      },

      // CSRF
      {
        id: 'csrf-1',
        name: 'Missing CSRF Protection',
        type: 'csrf',
        severity: 'high',
        pattern: /app\.(?:post|put|delete)\s*\([^)]*\)\s*{[^}]*(?!csrf)/i,
        description: 'POST/PUT/DELETE endpoint without CSRF protection',
        remediation: 'Implement CSRF token validation',
        owaspCategory: 'A01-broken-access-control',
      },

      // Open Redirect
      {
        id: 'open-redirect-1',
        name: 'Open Redirect',
        type: 'open-redirect',
        severity: 'medium',
        pattern: /(?:redirect|location)\s*\(\s*(?:req\.query|req\.params|req\.body)/,
        description: 'Redirecting to user-controlled URL',
        remediation: 'Validate redirect URLs against whitelist',
        owaspCategory: 'A01-broken-access-control',
      },

      // Sensitive Data Exposure
      {
        id: 'sensitive-data-1',
        name: 'Logging Sensitive Data',
        type: 'sensitive-data-exposure',
        severity: 'medium',
        pattern: /console\.log\s*\([^)]*(?:password|token|secret|key)[^)]*\)/i,
        description: 'Logging potentially sensitive information',
        remediation: 'Remove or mask sensitive data before logging',
        owaspCategory: 'A02-cryptographic-failures',
      },

      // Broken Access Control
      {
        id: 'access-control-1',
        name: 'Missing Authorization Check',
        type: 'broken-access-control',
        severity: 'high',
        pattern: /app\.(?:get|post|put|delete)\s*\([^)]*\)\s*{[^}]{0,200}(?!(?:isAuthenticated|requireAuth|checkAuth))/i,
        description: 'Route handler without authorization check',
        remediation: 'Add authentication/authorization middleware',
        owaspCategory: 'A01-broken-access-control',
      },
    ];
  }

  /**
   * Get code context around vulnerability
   */
  private getContext(lines: string[], lineIndex: number): string[] {
    const context: string[] = [];
    const start = Math.max(0, lineIndex - 2);
    const end = Math.min(lines.length, lineIndex + 3);

    for (let i = start; i < end; i++) {
      context.push(lines[i]);
    }

    return context;
  }

  /**
   * Get remediation steps for vulnerability type
   */
  private getRemediationSteps(type: VulnerabilityType): string[] {
    const steps: Record<VulnerabilityType, string[]> = {
      'sql-injection': [
        'Replace string concatenation with parameterized queries',
        'Use ORM or query builder with parameterization',
        'Validate and sanitize all user inputs',
        'Apply principle of least privilege to database user',
      ],
      xss: [
        'Sanitize all user input before rendering',
        'Use Content Security Policy (CSP) headers',
        'Encode output based on context (HTML, JavaScript, URL)',
        'Use framework built-in protection (React auto-escaping)',
      ],
      'command-injection': [
        'Use safe APIs that accept arrays instead of strings',
        'Validate and sanitize all user input',
        'Use allowlist for permitted commands',
        'Run with minimal privileges',
      ],
      'path-traversal': [
        'Validate file paths against allowlist',
        'Use path.resolve() and check if path is within allowed directory',
        'Never use user input directly in file paths',
        'Implement proper access controls',
      ],
      'insecure-deserialization': [
        'Validate input schema before deserialization',
        'Use safe deserialization libraries',
        'Implement integrity checks',
        'Avoid deserializing untrusted data',
      ],
      xxe: [
        'Disable XML external entity processing',
        'Use less complex data formats like JSON',
        'Validate and sanitize XML input',
        'Update XML parsers to latest versions',
      ],
      ssrf: [
        'Validate and sanitize URLs',
        'Use allowlist for permitted domains',
        'Disable redirects in HTTP clients',
        'Implement network segmentation',
      ],
      'open-redirect': [
        'Validate redirect URLs against allowlist',
        'Use relative paths for internal redirects',
        'Warn users about external redirects',
        'Implement redirect token validation',
      ],
      csrf: [
        'Implement CSRF tokens for state-changing operations',
        'Use SameSite cookie attribute',
        'Verify Origin/Referer headers',
        'Require re-authentication for sensitive actions',
      ],
      'broken-auth': [
        'Implement proper session management',
        'Use strong password policies',
        'Implement multi-factor authentication',
        'Use secure session cookies',
      ],
      'sensitive-data-exposure': [
        'Encrypt sensitive data at rest and in transit',
        'Remove sensitive data from logs',
        'Implement proper access controls',
        'Use environment variables for secrets',
      ],
      'broken-access-control': [
        'Implement proper authorization checks',
        'Use role-based access control (RBAC)',
        'Deny by default',
        'Validate permissions on server side',
      ],
      'security-misconfiguration': [
        'Remove default accounts and credentials',
        'Disable unnecessary features and services',
        'Keep all software up to date',
        'Implement security headers',
      ],
      'insecure-dependencies': [
        'Update dependencies to latest secure versions',
        'Use dependency scanning tools',
        'Remove unused dependencies',
        'Pin dependency versions',
      ],
      'hardcoded-secrets': [
        'Move secrets to environment variables',
        'Use secret management service',
        'Rotate compromised credentials immediately',
        'Implement secrets scanning in CI/CD',
      ],
      'weak-crypto': [
        'Use strong cryptographic algorithms',
        'Use appropriate key lengths',
        'Implement proper key management',
        'Use established cryptographic libraries',
      ],
      'mass-assignment': [
        'Explicitly define allowed fields',
        'Use DTOs or validation schemas',
        'Implement proper input validation',
        'Use framework protection features',
      ],
      'buffer-overflow': [
        'Validate buffer sizes',
        'Use safe string handling functions',
        'Implement bounds checking',
        'Use memory-safe languages',
      ],
      'race-condition': [
        'Use proper synchronization mechanisms',
        'Implement atomic operations',
        'Use database transactions',
        'Implement proper locking',
      ],
    };

    return steps[type] || ['Review and fix the vulnerability'];
  }

  /**
   * Estimate remediation effort
   */
  private estimateEffort(type: VulnerabilityType): 'low' | 'medium' | 'high' {
    const highEffort: VulnerabilityType[] = [
      'broken-access-control',
      'broken-auth',
      'insecure-deserialization',
    ];
    const mediumEffort: VulnerabilityType[] = [
      'sql-injection',
      'xss',
      'command-injection',
      'csrf',
    ];

    if (highEffort.includes(type)) return 'high';
    if (mediumEffort.includes(type)) return 'medium';
    return 'low';
  }

  /**
   * Get references for vulnerability type
   */
  private getReferences(type: VulnerabilityType): string[] {
    return [
      `https://owasp.org/www-community/vulnerabilities/${type}`,
      'https://cwe.mitre.org/',
      'https://cheatsheetseries.owasp.org/',
    ];
  }
}
